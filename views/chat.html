<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    #messages { height: 360px; overflow-y: auto; background: #fff; border: 1px solid #ddd; padding: 10px; }
    .sys { font-style: italic; color: #666; }
  </style>
</head>
<body class="bg-light">

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center">
    <h3 class="m-0">Chat Room</h3>
    <button class="btn btn-outline-danger" id="logoutBtn">Logout</button>
  </div>

  <div class="card mt-3 shadow">
    <div class="card-body">

      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Rooms</label>
          <select id="roomSelect" class="form-select"></select>

          <div class="d-flex gap-2 mt-2">
            <button class="btn btn-primary w-100" id="joinBtn">Join</button>
            <button class="btn btn-secondary w-100" id="leaveBtn">Leave</button>
          </div>

          <div class="mt-3">
            <div class="small text-muted">Logged in as:</div>
            <div id="who" class="fw-bold"></div>
            <div class="small text-muted mt-2">Current room:</div>
            <div id="currentRoom" class="fw-bold">None</div>
          </div>
        </div>

        <div class="col-md-8">
          <div id="messages" class="rounded"></div>
          <div id="typing" class="mt-1 small text-muted"></div>

          <div class="input-group mt-2">
            <input id="messageInput" class="form-control" placeholder="Type message..." disabled />
            <button id="sendBtn" class="btn btn-success" disabled>Send</button>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  // âœ… session check (required behavior)
  const session = localStorage.getItem("sessionUser");
  if (!session) window.location.href = "/";

  const user = JSON.parse(session);
  document.getElementById("who").textContent = user.username;

  const socket = io();

  const roomSelect = document.getElementById("roomSelect");
  const joinBtn = document.getElementById("joinBtn");
  const leaveBtn = document.getElementById("leaveBtn");
  const currentRoomEl = document.getElementById("currentRoom");
  const messagesEl = document.getElementById("messages");
  const messageInput = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");
  const typingEl = document.getElementById("typing");

  let currentRoom = null;
  let typingTimer = null;

  function addLine(html) {
    const div = document.createElement("div");
    div.innerHTML = html;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  // Load rooms
  socket.emit("rooms:list");
  socket.on("rooms:list", (rooms) => {
    roomSelect.innerHTML = "";
    rooms.forEach(r => {
      const opt = document.createElement("option");
      opt.value = r;
      opt.textContent = r;
      roomSelect.appendChild(opt);
    });
  });

  // Join room
  joinBtn.addEventListener("click", () => {
    const room = roomSelect.value;
    socket.emit("room:join", { room, username: user.username });
    currentRoom = room;
    currentRoomEl.textContent = room;
    messageInput.disabled = false;
    sendBtn.disabled = false;

    messagesEl.innerHTML = "";
    addLine(`<div class="sys">Joined room: <b>${room}</b></div>`);
  });

  // Leave room
  leaveBtn.addEventListener("click", () => {
    socket.emit("room:leave");
    currentRoom = null;
    currentRoomEl.textContent = "None";
    messageInput.disabled = true;
    sendBtn.disabled = true;
    typingEl.textContent = "";
    addLine(`<div class="sys">You left the room.</div>`);
  });

  // Receive history
  socket.on("room:history", (history) => {
    messagesEl.innerHTML = "";
    history.forEach(m => {
      addLine(`<div><b>${m.from_user}:</b> ${m.message} <span class="text-muted small">(${m.date_sent})</span></div>`);
    });
  });

  // System message
  socket.on("room:system", (data) => {
    addLine(`<div class="sys">${data.message}</div>`);
  });

  // Receive message
  socket.on("room:message", (m) => {
    addLine(`<div><b>${m.from_user}:</b> ${m.message} <span class="text-muted small">(${m.date_sent})</span></div>`);
  });

  // Send message
  function sendMessage() {
    const text = messageInput.value.trim();
    if (!text || !currentRoom) return;
    socket.emit("room:message", text);
    messageInput.value = "";
  }

  sendBtn.addEventListener("click", sendMessage);
  messageInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") sendMessage();
  });

  // Typing indicator
  messageInput.addEventListener("input", () => {
    if (!currentRoom) return;

    socket.emit("typing");

    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => {
      typingEl.textContent = "";
    }, 700);
  });

  socket.on("typing", (text) => {
    typingEl.textContent = text;
    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => {
      typingEl.textContent = "";
    }, 700);
  });

  // Logout
  document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("sessionUser");
    window.location.href = "/";
  });
</script>

</body>
</html>
